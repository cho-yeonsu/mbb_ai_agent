<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Consulting Insights Dashboard</title>

  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<style>
  /* ì±„íŒ… íŒ¨ë„ ê°€ë…ì„± (ì´ë¯¸ ìˆìœ¼ë©´ ìƒëµ ê°€ëŠ¥) */
  #mbb-modal { width: 560px; max-width: 96vw; height: 78vh; max-height: 86vh; z-index: 99999; }
  #mbb-log   { height: calc(78vh - 140px); overflow: auto; font-size: 14px; line-height: 1.55; background: #fafafa; }
  #mbb-log .bubble { white-space: pre-wrap; background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 10px 12px; overflow-wrap: anywhere; }

  /* â€œìƒê°ì¤‘â€¦â€ ì í”„ ì• ë‹ˆë©”ì´ì…˜ */
  .thinking { display: flex; align-items: center; gap: 8px; color: #6b7280; font-size: 13px; }
  .dots:after { content: 'â€¦'; animation: dots 1.5s steps(4, end) infinite; display: inline-block; width: 1ch; text-align: left; }
  @keyframes dots { 0% { content: ''; } 33% { content: '.'; } 66% { content: '..'; } 100% { content: '...'; } }

  /* ë‹¨ê³„ë³„ ì§„í–‰ í…ìŠ¤íŠ¸ */
  .stage-box { margin-top: 8px; padding: 8px 10px; background: #f0f7ff; border: 1px solid #dbeafe; border-radius: 8px; color: #1e3a8a; }
  .stage-list { margin-top: 6px; list-style: none; padding: 0; }
  .stage-list li { font-size: 12px; padding: 4px 0; display: flex; align-items: center; gap: 6px; color: #1e3a8a; }
  .stage-list li .dot { width: 6px; height: 6px; border-radius: 999px; background: #93c5fd; display: inline-block; }
  .stage-list li.current { font-weight: 700; color: #1d4ed8; }
  .stage-list li.current .dot { background: #2563eb; }
  .stage-list li.done { color: #065f46; }
  .stage-list li.done .dot { background: #10b981; }
</style>

<body class="bg-gray-50">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="mb-12 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-tight">
        McKinsey, BCG & Bain ìµœì‹  ì¸ì‚¬ì´íŠ¸
      </h1>
      <p class="mt-2 text-lg text-gray-500">
        ê¸€ë¡œë²Œ TOP ì»¨ì„¤íŒ… íŒì˜ ìµœì‹  ì•„í‹°í´ì„ í™•ì¸í•˜ì„¸ìš”.
      </p>
      <div class="mt-8 max-w-lg mx-auto">
        <form id="search-form" class="relative">
          <input type="search" id="search-input" placeholder="í‚¤ì›Œë“œë¡œ ì¸ì‚¬ì´íŠ¸ ê²€ìƒ‰..."
                 class="w-full pl-4 pr-12 py-3 text-base bg-white border border-gray-300 rounded-full shadow-sm transition-colors duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <button type="submit" class="search-btn">
            <i data-lucide="search" class="w-5 h-5"></i>
          </button>
        </form>
      </div>
    </header>

    <main>
      <div id="loading-indicator" class="flex justify-center items-center py-20">
        <div class="loader"></div>
      </div>
      <div id="article-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </main>
  </div>

  <!-- ëŒ€ì‹œë³´ë“œ JS (ë„¤ê°€ ì“°ë˜ ì½”ë“œ) -->
  <script src="script.js" defer></script>

  <!-- ğŸ’¬ ê°„ë‹¨ ì±—ë´‡ UI (wf ê¸°ë°˜, /api/ask í˜¸ì¶œ) -->
  <button id="mbb-launcher"
    style="position:fixed;right:24px;bottom:24px;background:#2563eb;color:#fff;
           border:none;padding:12px 16px;border-radius:9999px;font-weight:600;
           box-shadow:0 8px 22px rgba(0,0,0,.25);cursor:pointer;z-index:9999;">
    ğŸ’¬ MBB AI ì±—ë´‡
  </button>

  <div id="mbb-modal"
    style="display:none;position:fixed;right:24px;bottom:84px;width:420px;max-width:92vw;
           height:560px;max-height:70vh;background:#fff;border:1px solid #e5e7eb;
           border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.18);overflow:hidden;z-index:9999;">
    <div style="padding:10px 16px;border-bottom:1px solid #eee;font-weight:700">MBB AI ì¸ì‚¬ì´íŠ¸</div>
    <div id="mbb-log" style="padding:12px;height:420px;overflow:auto;font-size:14px;line-height:1.55"></div>
    <form id="mbb-form" style="display:flex;gap:8px;padding:12px;border-top:1px solid #eee">
      <input id="mbb-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"
             style="flex:1;border:1px solid #ddd;border-radius:10px;padding:10px" />
      <button style="background:#2563eb;color:#fff;border:none;border-radius:10px;padding:10px 14px">ë³´ë‚´ê¸°</button>
    </form>
  </div>

 <script>
  // ====== DOM ì°¸ì¡° ======
  const $launcher = document.getElementById("mbb-launcher");
  const $modal    = document.getElementById("mbb-modal");
  const $close    = document.getElementById("mbb-close");
  const $form     = document.getElementById("mbb-form");
  const $input    = document.getElementById("mbb-input");
  const $log      = document.getElementById("mbb-log");
  const $send     = document.getElementById("mbb-send");

  // ====== ì´ë²¤íŠ¸ ======
  $launcher?.addEventListener("click", () => { $modal.style.display = "block"; $input.focus(); });
  $close?.addEventListener("click", () => { $modal.style.display = "none"; });

  $form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = ($input.value || "").trim();
    if (!text) return;

    appendUser(text);
    $input.value = "";
    setSending(true);

    // â‘  â€œìƒê°ì¤‘ + ë‹¨ê³„ í…ìŠ¤íŠ¸â€ í‘œì‹œ
    const thinking = appendThinkingRow();

    try {
      // ë„ˆì˜ ask API ê²½ë¡œ/í˜ì´ë¡œë“œ(ë³€ê²½ ê°€ëŠ¥)
      const r = await fetch("/api/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        appendAgent("âš ï¸ ì˜¤ë¥˜: " + (data?.error || `HTTP ${r.status}`));
      } else {
        // â‘¢ [1] â†’ <sup>[1]</sup> ë³€í™˜ í›„ ì¶œë ¥
        const html = toSuperscriptCitations(data?.answer || "(ì‘ë‹µ ì—†ìŒ)");
        appendAgentHTML(html);
      }
    } catch (err) {
      appendAgent("âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + (err?.message || err));
    } finally {
      // â‘¡ ë‹¨ê³„ í‘œì‹œ ì¢…ë£Œ
      clearThinking(thinking);
      setSending(false);
    }
  });

  // ====== í—¬í¼ë“¤ ======
  function setSending(s) {
    if (!$send) return;
    $send.disabled = s;
    $send.textContent = s ? "ì „ì†¡ì¤‘..." : "ë³´ë‚´ê¸°";
  }

  function appendUser(t) {
    $log.insertAdjacentHTML("beforeend",
      `<div><b>ë‚˜</b>:</div>
       <div class="bubble">${escapeHtml(t)}</div>`);
    $log.scrollTop = $log.scrollHeight;
  }

  function appendAgent(t) {
    $log.insertAdjacentHTML("beforeend",
      `<div style="margin-top:10px"><b>Agent</b>:</div>
       <div class="bubble">${escapeHtml(t)}</div>`);
    $log.scrollTop = $log.scrollHeight;
  }

  function appendAgentHTML(html) {
    $log.insertAdjacentHTML("beforeend",
      `<div style="margin-top:10px"><b>Agent</b>:</div>
       <div class="bubble">${html}</div>`);
    $log.scrollTop = $log.scrollHeight;
  }

  // ====== (í•µì‹¬) â€œìƒê°ì¤‘â€¦ + ë‹¨ê³„ í…ìŠ¤íŠ¸â€ ======
  // - ì§„ì§œ ìŠ¤íŠ¸ë¦¬ë°ì´ ì—†ìœ¼ë¯€ë¡œ, ìì—°ìŠ¤ëŸ¬ìš´ 'ë‹¨ê³„ ì „í™˜'ì„ ëª¨ì˜ë¡œ ë³´ì—¬ì¤Œ
  // - ë‹¨ê³„ ë¬¸êµ¬ëŠ” ë§ˆìŒëŒ€ë¡œ ë°”ê¿”ë„ ë¨
  function appendThinkingRow() {
    const id = "think-" + Date.now();
    const stages = [
      "ì§ˆë¬¸ ì˜ë„ íŒŒì•… ì¤‘",
      "ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰ ì¤‘",
      "í•µì‹¬ ë‚´ìš© ì„ ë³„ ì¤‘",
      "ìš”ì•½ ë° ê°ì£¼ êµ¬ì„± ì¤‘"
    ];

    const items = stages.map((s, i) =>
      `<li class="${i === 0 ? "current" : ""}" data-i="${i}">
         <span class="dot"></span>${s}
       </li>`).join("");

    $log.insertAdjacentHTML("beforeend", `
      <div id="${id}" style="margin-top:8px">
        <div class="thinking">ìƒê°ì¤‘<span class="dots"></span></div>
        <div class="stage-box">
          <ul class="stage-list" id="${id}-list">
            ${items}
          </ul>
        </div>
      </div>
    `);
    $log.scrollTop = $log.scrollHeight;

    const $list = document.getElementById(`${id}-list`);
    let idx = 0;

    // 0.9ì´ˆë§ˆë‹¤ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™ (ì‹¤ì œ ì‘ë‹µë³´ë‹¤ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ 3ê¹Œì§€)
    const timer = setInterval(() => {
      const lis = Array.from($list.querySelectorAll("li"));
      if (idx < lis.length) {
        lis[idx].classList.remove("current");
        lis[idx].classList.add("done");
        idx++;
        if (idx < lis.length) lis[idx].classList.add("current");
      } else {
        // 4ë‹¨ê³„ ì´í›„ì—” ë©ˆì¶¤ (ì‘ë‹µì´ ì˜¤ë©´ clearThinkingë¡œ ì œê±°ë¨)
        clearInterval(timer);
      }
    }, 900);

    return { id, timer };
  }

  function clearThinking(obj) {
    if (!obj) return;
    clearInterval(obj.timer);
    const el = document.getElementById(obj.id);
    if (el) el.remove();
  }

  // ====== [1] â†’ <sup>[1]</sup> ë³€í™˜ ======
  function toSuperscriptCitations(md) {
    // ë§í¬ [text](url)ì€ ê±´ë“œë¦¬ì§€ ì•Šê³ , ìˆœìˆ˜ [ìˆ«ì]ë§Œ <sup>ë¡œ
    const safe = md.replace(/(?<!\])\[(\d+)\](?!\()/g, (_m, g1) => `<sup>[${g1}]</sup>`);
    return safe
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/&lt;sup&gt;\[(\d+)\]&lt;\/sup&gt;/g, '<sup>[$1]</sup>')
      .replace(/\n/g, '<br/>');
  }

  function escapeHtml(s){
    return s.replace(/[&<>]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c]));
  }
</script>

</body>
</html>

