<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Consulting Insights Dashboard</title>

  <!-- 기본 스타일/폰트 -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ====== 기본 레이아웃 ====== */
    body { font-family: 'Noto Sans KR', sans-serif; background:#f9fafb; color:#111827; }

    /* ====== 모달 전체 구조 ====== */
    #mbb-modal{
      position: fixed; right: 16px; bottom: 96px;
      width: 560px; max-width: 94vw;
      height: min(82vh, 760px);
      display: none;
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.15);
      z-index: 99999;
    }
    .mbb-panel{ height:100%; display:flex; flex-direction:column; }

    #mbb-header{ flex:0 0 auto; padding:12px 14px; border-bottom:1px solid #eef2f7; font-weight:700 }
    #mbb-log{
      flex:1 1 auto; min-height:0; overflow:auto;
      padding:12px 14px; background:#fafafa;
      font-size:14px; line-height:1.55;
    }
    #mbb-footer{ flex:0 0 auto; padding:10px 12px; border-top:1px solid #eef2f7; background:#fff; }

    #mbb-log .bubble{
      white-space: pre-wrap; overflow-wrap: anywhere;
      background:#fff; border:1px solid #eee; border-radius:10px; padding:10px 12px;
    }
    #mbb-input{
      width:100%; resize:none; line-height:1.5;
      max-height:40vh; overflow:auto;
      border:1px solid #ddd; border-radius:10px; padding:10px;
    }

    /* 런처 버튼 */
    #mbb-launcher{
      position:fixed;right:24px;bottom:24px;
      background:#2563eb;color:#fff;
      border:none;padding:12px 16px;border-radius:9999px;
      font-weight:600;box-shadow:0 8px 22px rgba(0,0,0,.25);
      cursor:pointer;z-index:9999;
    }

    /* 생각중/단계 표시 */
    .thinking { display:flex; align-items:center; gap:8px; color:#6b7280; font-size:13px; }
    .dots:after { content:'…'; animation:dots 60s steps(4,end) infinite; display:inline-block; width:1ch; text-align:left; }
    @keyframes dots { 0%{content:'';} 33%{content:'.';} 66%{content:'..';} 100%{content:'...';} }
    .stage-box { margin-top:8px; padding:8px 10px; background:#f0f7ff; border:1px solid #dbeafe; border-radius:8px; color:#1e3a8a; }
    .stage-list { margin-top:6px; list-style:none; padding:0; }
    .stage-list li { font-size:12px; padding:4px 0; display:flex; align-items:center; gap:6px; color:#1e3a8a; }
    .stage-list li .dot { width:6px; height:6px; border-radius:999px; background:#93c5fd; display:inline-block; }
    .stage-list li.current { font-weight:700; color:#1d4ed8; }
    .stage-list li.current .dot { background:#2563eb; }
    .stage-list li.done { color:#065f46; }
    .stage-list li.done .dot { background:#10b981; }

    @media (max-width: 640px){
      #mbb-modal{ right:0; left:0; bottom:0; width:100vw; height:calc(92vh - env(safe-area-inset-bottom,0px)); border-radius:14px 14px 0 0; }
    }
  </style>
</head>

<body class="bg-gray-50">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="mb-12 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-tight">
        McKinsey, BCG & Bain 최신 인사이트
      </h1>
      <p class="mt-2 text-lg text-gray-500">
        글로벌 TOP 컨설팅 펌의 최신 아티클을 확인하세요.
      </p>
      <div class="mt-8 max-w-lg mx-auto">
        <form id="search-form" class="relative">
          <input type="search" id="search-input" placeholder="키워드로 인사이트 검색..."
                 class="w-full pl-4 pr-12 py-3 text-base bg-white border border-gray-300 rounded-full shadow-sm transition-colors duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <button type="submit" class="search-btn">
            <i data-lucide="search" class="w-5 h-5"></i>
          </button>
        </form>
      </div>
    </header>

    <main>
      <div id="loading-indicator" class="flex justify-center items-center py-20">
        <div class="loader"></div>
      </div>
      <div id="article-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </main>
  </div>

  <!-- 대시보드 JS -->
  <script src="script.js" defer></script>

  <!-- 💬 챗봇 런처 -->
  <button id="mbb-launcher">💬 MBB AI 챗봇</button>

  <!-- 💬 챗봇 모달 -->
  <div id="mbb-modal">
    <div class="mbb-panel">
      <div id="mbb-header">
        MBB AI 인사이트
        <button id="mbb-close" style="float:right;background:transparent;border:0;font-size:18px;cursor:pointer">×</button>
      </div>

      <div id="mbb-log"><!-- 대화 내용 --></div>

      <div id="mbb-footer">
        <form id="mbb-form" style="display:flex; gap:8px;">
          <textarea id="mbb-input" rows="1" placeholder="질문을 입력하세요"></textarea>
          <button id="mbb-send" type="submit"
                  style="background:#2563eb;color:#fff;border:none;border-radius:10px;padding:10px 14px">
            보내기
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- 💬 챗봇 스크립트 -->
  <script>
    const $launcher = document.getElementById("mbb-launcher");
    const $modal    = document.getElementById("mbb-modal");
    const $close    = document.getElementById("mbb-close");
    const $form     = document.getElementById("mbb-form");
    const $input    = document.getElementById("mbb-input");
    const $log      = document.getElementById("mbb-log");
    const $send     = document.getElementById("mbb-send");

    $launcher?.addEventListener("click", () => { $modal.style.display = "block"; setTimeout(()=>autogrow($input),0); $input.focus(); });
    $close?.addEventListener("click", () => { $modal.style.display = "none"; });

    function autogrow(el){
      el.style.height = 'auto';
      const max = Math.round(window.innerHeight * 0.4);
      el.style.height = Math.min(el.scrollHeight, max) + 'px';
    }
    $input.addEventListener('input', () => autogrow($input));

    $form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = ($input.value || "").trim();
      if (!text) return;
      appendUser(text);
      $input.value = ""; autogrow($input);
      setSending(true);

      const thinking = appendThinkingRow();
      try {
        const r = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) appendAgent("⚠️ 오류: " + (data?.error || `HTTP ${r.status}`));
        else appendAgentHTML(toSuperscriptCitations(data?.answer || "(응답 없음)"));
      } catch (err) {
        appendAgent("⚠️ 네트워크 오류: " + (err?.message || err));
      } finally {
        clearThinking(thinking);
        setSending(false);
      }
    });

    function setSending(s){ $send.disabled = s; $send.textContent = s ? "전송중..." : "보내기"; }
    function appendUser(t){
      $log.insertAdjacentHTML("beforeend", `<div><b>나</b>:</div><div class="bubble">${escapeHtml(t)}</div>`);
      $log.scrollTop = $log.scrollHeight;
    }
    function appendAgent(t){
      $log.insertAdjacentHTML("beforeend", `<div style="margin-top:10px"><b>Agent</b>:</div><div class="bubble">${escapeHtml(t)}</div>`);
      $log.scrollTop = $log.scrollHeight;
    }
    function appendAgentHTML(html){
      $log.insertAdjacentHTML("beforeend", `<div style="margin-top:10px"><b>Agent</b>:</div><div class="bubble">${html}</div>`);
      $log.scrollTop = $log.scrollHeight;
    }

    function appendThinkingRow(){
      const id = "think-" + Date.now();
      const stages = ["질문 의도 파악 중","관련 문서 검색 중","핵심 내용 선별 중","요약 및 각주 구성 중"];
      const items = stages.map((s,i)=>`<li class="${i===0?"current":""}" data-i="${i}"><span class="dot"></span>${s}</li>`).join("");
      $log.insertAdjacentHTML("beforeend", `
        <div id="${id}" style="margin-top:8px">
          <div class="thinking">생각중<span class="dots"></span></div>
          <div class="stage-box"><ul class="stage-list" id="${id}-list">${items}</ul></div>
        </div>
      `);
      $log.scrollTop = $log.scrollHeight;
      const $list = document.getElementById(`${id}-list`);
      let idx = 0;
      const timer = setInterval(()=>{
        const lis = Array.from($list.querySelectorAll("li"));
        if (idx < lis.length){
          lis[idx].classList.remove("current");
          lis[idx].classList.add("done");
          idx++; if (idx < lis.length) lis[idx].classList.add("current");
        } else clearInterval(timer);
      }, 900);
      return { id, timer };
    }
    function clearThinking(obj){ if(!obj) return; clearInterval(obj.timer); document.getElementById(obj.id)?.remove(); }

    function toSuperscriptCitations(md){
      const safe = md.replace(/(?<!\])\[(\d+)\](?!\()/g, (_m,g1)=>`<sup>[${g1}]</sup>`);
      return safe.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                 .replace(/&lt;sup&gt;\[(\d+)\]&lt;\/sup&gt;/g,'<sup>[$1]</sup>')
                 .replace(/\n/g,'<br/>');
    }
    function escapeHtml(s){ return s.replace(/[&<>]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }
  </script>
</body>
</html>
